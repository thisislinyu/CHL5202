{
  "hash": "d1cfd70a791a47d5e948bffebd047da0",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Linear Regression\"\nauthor: \"Lin Yu\"\ndate: \"2025-01-20\"\nformat: \n  html: \n    toc: true\n    embed-resources: true\n---\n\n\n\n\n\n\n\n\n## Q1\n\nLoad the data frame tut1 into R from the file tut1.RData available on the course page. The data frame contains the variables x and y.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nlibrary(here)\nlibrary(texreg)\nlibrary(rms)\nlibrary(kableExtra)\nlibrary(dplyr)\nlibrary(ggplot2)\noptions(prType = \"latex\")\noptions(prType='html')\nload(here(\"data\",'tut1.rdata'))\n\nknitr::opts_chunk$set(warning = FALSE,\n                      message = FALSE)\ntheme_set(\n  theme_bw(base_size = 18) +\n    theme(legend.position = \"bottom\")\n)\n```\n:::\n\n\n\n\n\n\n\n\nFit a simple linear regression with y as the response and x as the predictor\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit0 <- ols(y ~ x, data = tut1)\n```\n:::\n\n\n\n\n\n\n\n\n::: callout-note\nor you can use `glm` (generalized linear model) or `lm` (linear model)\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_glm <- glm(y~x, data= tut1)\nfit_lm <- lm(y~x, data = tut1)\n```\n:::\n\n\n\n\n\n\n\n:::\n\nThe results are identical! \n\n\n\n\n\n\n\n\n\n```{.r .cell-code  code-fold=\"true\"}\nhtmlreg(list(fit0, fit_lm,fit_glm), \n        ci.force = TRUE,\n        #custom.coef.map = keepvars,\n        custom.model.names = c(\"ols\", \"lm\",\"glm\"))\n```\n\n<table class=\"texreg\" style=\"margin: 10px auto;border-collapse: collapse;border-spacing: 0px;caption-side: bottom;color: #000000;border-top: 2px solid #000000;\">\n<caption>Statistical models</caption>\n<thead>\n<tr>\n<th style=\"padding-left: 5px;padding-right: 5px;\">&nbsp;</th>\n<th style=\"padding-left: 5px;padding-right: 5px;\">ols</th>\n<th style=\"padding-left: 5px;padding-right: 5px;\">lm</th>\n<th style=\"padding-left: 5px;padding-right: 5px;\">glm</th>\n</tr>\n</thead>\n<tbody>\n<tr style=\"border-top: 1px solid #000000;\">\n<td style=\"padding-left: 5px;padding-right: 5px;\">Intercept</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">1.22<sup>&#42;</sup></td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">&nbsp;</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">&nbsp;</td>\n</tr>\n<tr>\n<td style=\"padding-left: 5px;padding-right: 5px;\">&nbsp;</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">[ 0.80;  1.64]</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">&nbsp;</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">&nbsp;</td>\n</tr>\n<tr>\n<td style=\"padding-left: 5px;padding-right: 5px;\">x</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">-0.36<sup>&#42;</sup></td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">-0.36<sup>&#42;</sup></td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">-0.36<sup>&#42;</sup></td>\n</tr>\n<tr>\n<td style=\"padding-left: 5px;padding-right: 5px;\">&nbsp;</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">[-0.48; -0.24]</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">[-0.48; -0.24]</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">[-0.48; -0.24]</td>\n</tr>\n<tr>\n<td style=\"padding-left: 5px;padding-right: 5px;\">(Intercept)</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">&nbsp;</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">1.22<sup>&#42;</sup></td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">1.22<sup>&#42;</sup></td>\n</tr>\n<tr>\n<td style=\"padding-left: 5px;padding-right: 5px;\">&nbsp;</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">&nbsp;</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">[ 0.80;  1.64]</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">[ 0.80;  1.64]</td>\n</tr>\n<tr style=\"border-top: 1px solid #000000;\">\n<td style=\"padding-left: 5px;padding-right: 5px;\">Num. obs.</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">100</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">100</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">100</td>\n</tr>\n<tr>\n<td style=\"padding-left: 5px;padding-right: 5px;\">R<sup>2</sup></td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">0.27</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">0.27</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">&nbsp;</td>\n</tr>\n<tr>\n<td style=\"padding-left: 5px;padding-right: 5px;\">Adj. R<sup>2</sup></td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">0.27</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">0.27</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">&nbsp;</td>\n</tr>\n<tr>\n<td style=\"padding-left: 5px;padding-right: 5px;\">L.R.</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">32.07</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">&nbsp;</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">&nbsp;</td>\n</tr>\n<tr>\n<td style=\"padding-left: 5px;padding-right: 5px;\">AIC</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">&nbsp;</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">&nbsp;</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">303.66</td>\n</tr>\n<tr>\n<td style=\"padding-left: 5px;padding-right: 5px;\">BIC</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">&nbsp;</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">&nbsp;</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">311.48</td>\n</tr>\n<tr>\n<td style=\"padding-left: 5px;padding-right: 5px;\">Log Likelihood</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">&nbsp;</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">&nbsp;</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">-148.83</td>\n</tr>\n<tr style=\"border-bottom: 2px solid #000000;\">\n<td style=\"padding-left: 5px;padding-right: 5px;\">Deviance</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">&nbsp;</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">&nbsp;</td>\n<td style=\"padding-left: 5px;padding-right: 5px;\">114.89</td>\n</tr>\n</tbody>\n<tfoot>\n<tr>\n<td style=\"font-size: 0.8em;\" colspan=\"4\"><sup>&#42;</sup> Null hypothesis value outside the confidence interval.</td>\n</tr>\n</tfoot>\n</table>\n\n\n\n\n\n\n\n\nDiagnostic plots for model checking\n\n::: callout-tip\nIf the model is correctly specified, and all assumptions (known as **LINE**) are met, the residuals should be randomly scattered around zero\n:::\n\n\n\n\n\n\n\n\n::: {.cell layout-ncol=\"3\" tbl-cap='Scatter plots' tbl-subcap='true'}\n\n```{.r .cell-code}\npred_glm <- tut1 %>% \n             mutate(\n               yobs = y,\n           yhat = predict(fit_glm),\n           resid = y - yhat)\n\nx_y_plot <- ggplot(pred_glm, aes(x,yobs) )+\n  geom_point()+\n  geom_smooth()\n\nx_resid_plot <- ggplot(pred_glm, aes(x,resid) )+\n  geom_point()+\n  geom_smooth()\n\n\nyhat_resid_plot <- ggplot(pred_glm, aes(yhat,resid) )+\n  geom_point()+\n  geom_smooth()\n\nx_y_plot\n```\n\n::: {.cell-output-display}\n![](Tut1_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n\n```{.r .cell-code}\nx_resid_plot \n```\n\n::: {.cell-output-display}\n![](Tut1_files/figure-html/unnamed-chunk-5-2.png){width=672}\n:::\n\n```{.r .cell-code}\nyhat_resid_plot\n```\n\n::: {.cell-output-display}\n![](Tut1_files/figure-html/unnamed-chunk-5-3.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\npredicted result using restricted cubic spline (skyblue) versus simple linear (black)\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_rcs <- ols(y ~ rcs(x, 3), data = tut1)\n\npred_rcs <- tut1 %>% \n  mutate(\n    pred_rcs = predict(fit_rcs,data = tut1)\n  )\n  \npred_rcs %>% ggplot( aes(x =x, y = pred_rcs))+\n # geom_point(size = 0.01)+\n  geom_line(color = \"skyblue\")+\n # geom_point(data =pred_glm, aes(x =x, y = yhat) ,size = 0.01, ) +\ngeom_line(data =pred_glm, aes(x =x, y = yhat),color = \"black\"  ,alpha = 0.7)\n```\n\n::: {.cell-output-display}\n![](Tut1_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\nCheck the diagnostic plots again (`knots = 3`)\n\n\n\n\n\n\n\n\n::: {.cell layout-ncol=\"3\" tbl-cap='Scatter plots' tbl-subcap='true'}\n\n```{.r .cell-code}\npred_rcs <- tut1 %>% \n             mutate(\n               yobs = y,\n           yhat = predict(fit_rcs),\n           resid = y - yhat)\n\nx_y_plot <- ggplot(pred_rcs, aes(x,yobs) )+\n  geom_point()+\n  geom_smooth()\n\nx_resid_plot <- ggplot(pred_rcs, aes(x,resid) )+\n  geom_point()+\n  geom_smooth()\n\n\nyhat_resid_plot <- ggplot(pred_rcs, aes(yhat,resid) )+\n  geom_point()+\n  geom_smooth()\n\nx_y_plot\n```\n\n::: {.cell-output-display}\n![](Tut1_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n\n```{.r .cell-code}\nx_resid_plot \n```\n\n::: {.cell-output-display}\n![](Tut1_files/figure-html/unnamed-chunk-7-2.png){width=672}\n:::\n\n```{.r .cell-code}\nyhat_resid_plot\n```\n\n::: {.cell-output-display}\n![](Tut1_files/figure-html/unnamed-chunk-7-3.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n\n\nexperiment with different knot values:\n\n::: {.panel-tabset}\n\n### knot = 4\n\n\n\n\n\n\n\n::: {.cell layout-ncol=\"3\" tbl-cap='Scatter plots' tbl-subcap='true'}\n\n```{.r .cell-code  code-fold=\"true\"}\nfit_rcs <- ols(y ~ rcs(x, 5), data = tut1)\npred_rcs <- tut1 %>% \n             mutate(\n               yobs = y,\n           yhat = predict(fit_rcs),\n           resid = y - yhat)\n\nx_y_plot <- ggplot(pred_rcs, aes(x,yobs) )+\n  geom_point()+\n  geom_smooth()\n\nx_resid_plot <- ggplot(pred_rcs, aes(x,resid) )+\n  geom_point()+\n  geom_smooth()\n\n\nyhat_resid_plot <- ggplot(pred_rcs, aes(yhat,resid) )+\n  geom_point()+\n  geom_smooth()\n\nx_y_plot\n```\n\n::: {.cell-output-display}\n![](Tut1_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n\n```{.r .cell-code  code-fold=\"true\"}\nx_resid_plot \n```\n\n::: {.cell-output-display}\n![](Tut1_files/figure-html/unnamed-chunk-8-2.png){width=672}\n:::\n\n```{.r .cell-code  code-fold=\"true\"}\nyhat_resid_plot\n```\n\n::: {.cell-output-display}\n![](Tut1_files/figure-html/unnamed-chunk-8-3.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n\n### knot = 5\n\n\n\n\n\n\n\n::: {.cell layout-ncol=\"3\" tbl-cap='Scatter plots' tbl-subcap='true'}\n\n```{.r .cell-code  code-fold=\"true\"}\nfit_rcs <- ols(y ~ rcs(x, 5), data = tut1)\npred_rcs <- tut1 %>% \n             mutate(\n               yobs = y,\n           yhat = predict(fit_rcs),\n           resid = y - yhat)\n\nx_y_plot <- ggplot(pred_rcs, aes(x,yobs) )+\n  geom_point()+\n  geom_smooth()\n\nx_resid_plot <- ggplot(pred_rcs, aes(x,resid) )+\n  geom_point()+\n  geom_smooth()\n\n\nyhat_resid_plot <- ggplot(pred_rcs, aes(yhat,resid) )+\n  geom_point()+\n  geom_smooth()\n\nx_y_plot\n```\n\n::: {.cell-output-display}\n![](Tut1_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n\n```{.r .cell-code  code-fold=\"true\"}\nx_resid_plot \n```\n\n::: {.cell-output-display}\n![](Tut1_files/figure-html/unnamed-chunk-9-2.png){width=672}\n:::\n\n```{.r .cell-code  code-fold=\"true\"}\nyhat_resid_plot\n```\n\n::: {.cell-output-display}\n![](Tut1_files/figure-html/unnamed-chunk-9-3.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n:::\n\nConclusion: `knots = 4` is good enough to fit the data! `knots = 5` may lead to **overfitting**.\n\n## Q2\n\n> Q2 is a similar question but with more than one predictor!\n\nLoad the data frame FEV from the file FEV.RData. For these data, use the variable fev as the response and the rest as the explanatory covariates.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nload(here('data','FEV.rdata'))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nFEV %>% \n  head() %>% \n  kable()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> id </th>\n   <th style=\"text-align:right;\"> age </th>\n   <th style=\"text-align:right;\"> fev </th>\n   <th style=\"text-align:right;\"> height </th>\n   <th style=\"text-align:left;\"> sex </th>\n   <th style=\"text-align:left;\"> smoke </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 301 </td>\n   <td style=\"text-align:right;\"> 9 </td>\n   <td style=\"text-align:right;\"> 1.708 </td>\n   <td style=\"text-align:right;\"> 57.0 </td>\n   <td style=\"text-align:left;\"> female </td>\n   <td style=\"text-align:left;\"> non-current smoker </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 451 </td>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:right;\"> 1.724 </td>\n   <td style=\"text-align:right;\"> 67.5 </td>\n   <td style=\"text-align:left;\"> female </td>\n   <td style=\"text-align:left;\"> non-current smoker </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 501 </td>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:right;\"> 1.720 </td>\n   <td style=\"text-align:right;\"> 54.5 </td>\n   <td style=\"text-align:left;\"> female </td>\n   <td style=\"text-align:left;\"> non-current smoker </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 642 </td>\n   <td style=\"text-align:right;\"> 9 </td>\n   <td style=\"text-align:right;\"> 1.558 </td>\n   <td style=\"text-align:right;\"> 53.0 </td>\n   <td style=\"text-align:left;\"> male </td>\n   <td style=\"text-align:left;\"> non-current smoker </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 901 </td>\n   <td style=\"text-align:right;\"> 9 </td>\n   <td style=\"text-align:right;\"> 1.895 </td>\n   <td style=\"text-align:right;\"> 57.0 </td>\n   <td style=\"text-align:left;\"> male </td>\n   <td style=\"text-align:left;\"> non-current smoker </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1701 </td>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:right;\"> 2.336 </td>\n   <td style=\"text-align:right;\"> 61.0 </td>\n   <td style=\"text-align:left;\"> female </td>\n   <td style=\"text-align:left;\"> non-current smoker </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n\n\n\n\nFit an additive linear model to fev using the other variables as the covariates. Evaluate whether any of the continuous variables should be fit as non-linear terms.\n\nfit the linear model\n\n\n\n\n\n\n\n::: {.cell layout-ncol=\"2\" tbl-cap='Residual plots' tbl-subcap='true'}\n\n```{.r .cell-code}\nfev_lm <- ols(fev ~ age + height + sex + smoke,\n               data = FEV)\n\npred_fev <- FEV %>% \n             mutate(\n               yobs = fev,\n           yhat = predict(fev_lm),\n           resid = yobs - yhat)\n\nage_resid_plot <- ggplot(pred_fev, aes(age,resid) )+\n  geom_point()+\n  geom_smooth()\n\nheight_resid_plot <- ggplot(pred_fev, aes(height,resid) )+\n  geom_point()+\n  geom_smooth()\n\nage_resid_plot\n```\n\n::: {.cell-output-display}\n![](Tut1_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n\n```{.r .cell-code}\nheight_resid_plot\n```\n\n::: {.cell-output-display}\n![](Tut1_files/figure-html/unnamed-chunk-12-2.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n:::{.callout-warning}\n### What do the residual plots indicate?\nnon-linear relationship!\n:::\n\nFit RCS:\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfev_rcs <- ols(fev ~ rcs(age, 4) + rcs(height, 4) + sex + smoke,\n                data = FEV)\n```\n:::\n\n\n\n\n\n\n\n\nAgain, check the diagnostic plots:\n\n\n\n\n\n\n\n\n::: {.cell layout-ncol=\"3\"}\n\n```{.r .cell-code}\npred_fev <- FEV %>% \n             mutate(\n               yobs = fev,\n           yhat = predict(fev_rcs),\n           resid = yobs - yhat)\n\nage_y_plot <- ggplot(pred_fev, aes(age,yobs) )+\n  geom_point()+\n  geom_smooth()\n\nage_resid_plot <- ggplot(pred_fev, aes(age,resid) )+\n  geom_point()+\n  geom_smooth()\n\n\nyhat_resid_plot <- ggplot(pred_fev, aes(yhat,resid) )+\n  geom_point()+\n  geom_smooth()\n\nage_y_plot\n```\n\n::: {.cell-output-display}\n![](Tut1_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n\n```{.r .cell-code}\nage_resid_plot \n```\n\n::: {.cell-output-display}\n![](Tut1_files/figure-html/unnamed-chunk-14-2.png){width=672}\n:::\n\n```{.r .cell-code}\nyhat_resid_plot\n```\n\n::: {.cell-output-display}\n![](Tut1_files/figure-html/unnamed-chunk-14-3.png){width=672}\n:::\n:::\n\n::: {.cell layout-ncol=\"3\"}\n\n```{.r .cell-code}\nheight_y_plot <- ggplot(pred_fev, aes(height,yobs) )+\n  geom_point()+\n  geom_smooth()\n\nheight_resid_plot <- ggplot(pred_fev, aes(height,resid) )+\n  geom_point()+\n  geom_smooth()\n\n\nyhat_resid_plot <- ggplot(pred_fev, aes(yhat,resid) )+\n  geom_point()+\n  geom_smooth()\n\nheight_y_plot\n```\n\n::: {.cell-output-display}\n![](Tut1_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n\n```{.r .cell-code}\nheight_resid_plot \n```\n\n::: {.cell-output-display}\n![](Tut1_files/figure-html/unnamed-chunk-15-2.png){width=672}\n:::\n\n```{.r .cell-code}\nyhat_resid_plot\n```\n\n::: {.cell-output-display}\n![](Tut1_files/figure-html/unnamed-chunk-15-3.png){width=672}\n:::\n:::\n",
    "supporting": [
      "Tut1_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}