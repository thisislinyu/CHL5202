{
  "hash": "69f598f70ad65010c726b33a0a798c03",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Logistic Regression 2\"\nauthor: \"Lin Yu\"\ndate: \"2025-02-10\"\nformat: \n  html: \n    toc: true\n    embed-resources: true\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(DT)\nlibrary(here)\n```\n:::\n\n\n\n\n\n\n## Recap of Tutorial 3\n\n\n1. How would you calculate the estimated mean outcome (probability of otucome being positive, $E(Y) = P(Y=1)$)\n\n:::{.callout-note collapse=\"true\"}\n### Check Answer\n$\\hat P(Y=1) = \\frac{exp(\\hat Z)}{1+exp(\\hat Z)}$, where $Z$ is the linear combination of predictors\n::: \n\n2. For (generalized) linear regression $g(E(Y)) = \\beta_0 + \\beta_1 X_1 +\\ldots + \\beta_p X_p$, the MLE estimators $\\boldsymbol{\\hat \\beta} = [ \\hat\\beta_0, \\hat \\beta_1,\\ldots \\hat \\beta_p]$ follows a multivariate normal distribution, each $\\hat \\beta$ is a normal distribution.\n\n3. if I have a R.V. $\\hat \\beta = [\\hat \\beta_1, \\hat \\beta_2]$ follows a bivariate normal distribution, how do we calculate the variance for $\\beta_1+\\beta_2$ , and for $a \\beta_1 + b\\beta_2$?\n\n:::{.callout-note collapse=\"true\"}\n### Check Answer\n$$\n\\begin{bmatrix} \\beta_1 \\\\ \\beta_2 \\end{bmatrix} \\sim N\\left( \\begin{bmatrix} \\mu_1 \\\\ \\mu_2 \\end{bmatrix}, \\begin{bmatrix} \\sigma_1^2 & \\rho \\sigma_1 \\sigma_2 \\\\ \\rho \\sigma_1 \\sigma_2 & \\sigma_2^2 \\end{bmatrix} \\right),\n$$\n\nwhere $\\rho \\sigma_1 \\sigma_2$ is the covariance between $\\beta_1$ and $\\beta_2$. \n\nthe variance of $\\beta_1 + \\beta_2$ is given by:\n$$\n\\text{Var}(\\beta_1 + \\beta_2) = \\sigma_1^2 + \\sigma_2^2 + 2\\rho \\sigma_1 \\sigma_2.\n$$\n$$\n\\text{Var}(a\\beta_1 + b\\beta_2) = a^2\\sigma_1^2 + b^2\\sigma_2^2 + 2ab\\rho \\sigma_1 \\sigma_2.\n$$\n:::\n\n4. Given 1-3, do you know how can we calculate the variance of the estiamted probability of the outcome being positive ($\\hat P(Y=1)$)?\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(rms)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: Hmisc\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'Hmisc'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:dplyr':\n\n    src, summarize\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:base':\n\n    format.pval, units\n```\n\n\n:::\n\n```{.r .cell-code}\nload(here(\"data\",\"tutdata.RData\"))\ndd <- datadist(tutdata)\noptions(datadist = \"dd\")\n\nfit1 <- glm(y ~ blood.pressure + sex + age + cholesterol, data = tutdata,family = binomial(\"logit\"))\n\nsummary(fit1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = y ~ blood.pressure + sex + age + cholesterol, family = binomial(\"logit\"), \n    data = tutdata)\n\nCoefficients:\n                Estimate Std. Error z value Pr(>|z|)    \n(Intercept)    -1.777923   0.822041  -2.163 0.030555 *  \nblood.pressure -0.002645   0.004299  -0.615 0.538367    \nsexmale         0.474873   0.129886   3.656 0.000256 ***\nage             0.033198   0.006587   5.040 4.66e-07 ***\ncholesterol     0.001845   0.002652   0.696 0.486489    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 1379.9  on 999  degrees of freedom\nResidual deviance: 1339.6  on 995  degrees of freedom\nAIC: 1349.6\n\nNumber of Fisher Scoring iterations: 4\n```\n\n\n:::\n\n```{.r .cell-code}\nanova(fit1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAnalysis of Deviance Table\n\nModel: binomial, link: logit\n\nResponse: y\n\nTerms added sequentially (first to last)\n\n               Df Deviance Resid. Df Resid. Dev\nNULL                             999     1379.9\nblood.pressure  1   0.2057       998     1379.7\nsex             1  13.0804       997     1366.6\nage             1  26.5172       996     1340.1\ncholesterol     1   0.4846       995     1339.6\n```\n\n\n:::\n\n```{.r .cell-code}\nfit1 %>% coef()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   (Intercept) blood.pressure        sexmale            age    cholesterol \n  -1.777923213   -0.002645049    0.474872640    0.033197626    0.001845301 \n```\n\n\n:::\n\n```{.r .cell-code}\nfit1 %>% vcov()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                (Intercept) blood.pressure       sexmale           age\n(Intercept)     0.675751422  -2.230627e-03 -8.100279e-03 -2.126477e-03\nblood.pressure -0.002230627   1.848061e-05 -4.786796e-06 -1.078910e-06\nsexmale        -0.008100279  -4.786796e-06  1.687037e-02  3.554780e-05\nage            -0.002126477  -1.078910e-06  3.554780e-05  4.338693e-05\ncholesterol    -0.001467499   3.526787e-07 -4.926132e-06  3.650156e-07\n                 cholesterol\n(Intercept)    -1.467499e-03\nblood.pressure  3.526787e-07\nsexmale        -4.926132e-06\nage             3.650156e-07\ncholesterol     7.031300e-06\n```\n\n\n:::\n\n```{.r .cell-code}\n## point estimate of beta_sex\nbeta_sex_hat <- coef(fit1)[\"sexmale\"]\n\n## standard error for coef of sex\nbeta_sex_se <- sqrt(vcov(fit1)[3,3])\n\n## we know beta_hat follows a normal distribution, with mean=beta_sex_hat, \n\nalpha <- qnorm(0.975,mean=0,sd=1)\nalpha\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 1.959964\n```\n\n\n:::\n\n```{.r .cell-code}\nupper <- exp(beta_sex_hat + alpha*beta_sex_se)\nlower <- exp(beta_sex_hat - alpha*beta_sex_se)\n\nlower \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n sexmale \n1.246452 \n```\n\n\n:::\n\n```{.r .cell-code}\nupper \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n sexmale \n2.073928 \n```\n\n\n:::\n\n```{.r .cell-code}\npredict(fit1,type=\"response\") %>% head()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n        1         2         3         4         5         6 \n0.5283084 0.5846051 0.4750915 0.5317948 0.6572165 0.6022435 \n```\n\n\n:::\n\n```{.r .cell-code}\ndesign_matrix <- model.matrix(y~blood.pressure + sex + age + cholesterol, data=tutdata)\n\ndesign_matrix %>% head()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  (Intercept) blood.pressure sexmale      age cholesterol\n1           1       98.37248       1 39.84991    191.6668\n2           1      112.99815       1 49.20363    168.1024\n3           1      100.90785       0 47.67013    196.4870\n4           1      122.22211       1 41.82732    197.8634\n5           1      125.38972       1 57.72091    200.2004\n6           1      118.71428       1 48.34388    231.3853\n```\n\n\n:::\n\n```{.r .cell-code}\ndesign_matrix[1,]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   (Intercept) blood.pressure        sexmale            age    cholesterol \n       1.00000       98.37248        1.00000       39.84991      191.66681 \n```\n\n\n:::\n\n```{.r .cell-code}\nfit1 %>% coef()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   (Intercept) blood.pressure        sexmale            age    cholesterol \n  -1.777923213   -0.002645049    0.474872640    0.033197626    0.001845301 \n```\n\n\n:::\n\n```{.r .cell-code}\n## linear combination of predictors\nZ <- design_matrix[1,] %*% (fit1 %>% coef())\n\np_hat <- exp(Z)/(1+exp(Z))\n\np_hat\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n          [,1]\n[1,] 0.5283084\n```\n\n\n:::\n:::\n\n\n\n\n\n\n## Tutorial 4\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit1 <- lrm(y ~ blood.pressure + sex + age + rcs(cholesterol,4), data = tutdata)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfit2 <- lrm(y ~ blood.pressure + sex * (age + rcs(cholesterol,4)), data = tutdata)\nanova(fit2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                Wald Statistics          Response: y \n\n Factor                                           Chi-Square d.f. P     \n blood.pressure                                    0.26       1   0.6105\n sex  (Factor+Higher Order Factors)               38.71       5   <.0001\n  All Interactions                                26.13       4   <.0001\n age  (Factor+Higher Order Factors)               30.42       2   <.0001\n  All Interactions                                 3.86       1   0.0495\n cholesterol  (Factor+Higher Order Factors)       23.78       6   0.0006\n  All Interactions                                22.47       3   0.0001\n  Nonlinear (Factor+Higher Order Factors)          5.33       4   0.2550\n sex * age  (Factor+Higher Order Factors)          3.86       1   0.0495\n sex * cholesterol  (Factor+Higher Order Factors) 22.47       3   0.0001\n  Nonlinear                                        4.79       2   0.0911\n  Nonlinear Interaction : f(A,B) vs. AB            4.79       2   0.0911\n TOTAL NONLINEAR                                   5.33       4   0.2550\n TOTAL INTERACTION                                26.13       4   <.0001\n TOTAL NONLINEAR + INTERACTION                    26.81       6   0.0002\n TOTAL                                            62.26      10   <.0001\n```\n\n\n:::\n\n```{.r .cell-code}\nanova(fit2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                Wald Statistics          Response: y \n\n Factor                                           Chi-Square d.f. P     \n blood.pressure                                    0.26       1   0.6105\n sex  (Factor+Higher Order Factors)               38.71       5   <.0001\n  All Interactions                                26.13       4   <.0001\n age  (Factor+Higher Order Factors)               30.42       2   <.0001\n  All Interactions                                 3.86       1   0.0495\n cholesterol  (Factor+Higher Order Factors)       23.78       6   0.0006\n  All Interactions                                22.47       3   0.0001\n  Nonlinear (Factor+Higher Order Factors)          5.33       4   0.2550\n sex * age  (Factor+Higher Order Factors)          3.86       1   0.0495\n sex * cholesterol  (Factor+Higher Order Factors) 22.47       3   0.0001\n  Nonlinear                                        4.79       2   0.0911\n  Nonlinear Interaction : f(A,B) vs. AB            4.79       2   0.0911\n TOTAL NONLINEAR                                   5.33       4   0.2550\n TOTAL INTERACTION                                26.13       4   <.0001\n TOTAL NONLINEAR + INTERACTION                    26.81       6   0.0002\n TOTAL                                            62.26      10   <.0001\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n\n\ncompare two models using LRT. To use LRT, one model needs to be nested within a larger model.\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlrtest(fit1,fit2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nModel 1: y ~ blood.pressure + sex + age + rcs(cholesterol, 4)\nModel 2: y ~ blood.pressure + sex * (age + rcs(cholesterol, 4))\n\n  L.R. Chisq         d.f.            P \n2.831616e+01 4.000000e+00 1.076137e-05 \n```\n\n\n:::\n:::\n\n\n\n\n\n\nvisualize the effect modifications:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(Predict(fit2,age,sex))\n```\n\n::: {.cell-output-display}\n![](Tut4_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n\n```{.r .cell-code}\nplot(Predict(fit2,cholesterol,sex))\n```\n\n::: {.cell-output-display}\n![](Tut4_files/figure-html/unnamed-chunk-6-2.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\nwhat would the plots look like without effect modification:\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(Predict(fit1, age, sex = \"male\"))\n```\n\n::: {.cell-output-display}\n![](Tut4_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n\n```{.r .cell-code}\nplot(Predict(fit1, age, sex = \"female\"))\n```\n\n::: {.cell-output-display}\n![](Tut4_files/figure-html/unnamed-chunk-7-2.png){width=672}\n:::\n:::\n",
    "supporting": [
      "Tut4_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}