{
  "hash": "e4164586a8f8c74aaa5e2e6b3fb848c6",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Survival Analysis 2\"\nauthor: \"Lin Yu\"\ndate: \"2025-03-10\"\nformat: \n  html: \n    toc: true\n    embed-resources: true\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(DT)\nlibrary(here)\n```\n:::\n\n\n\n\n\n\n## Recap of Tutorial 6\n\nWe went over how KM estimator (for survival probability) is constructed for discrete time case. The idea being that we look for the connections among survial function, hazard function and the cumulative density function. \n\nThe derivations can be found [here](https://lin-yu.me/cheatsheet/2024_02_12likelihood_survival/) \n\nThe non-parametric estimator for hazard is quite intuitive. \n\n$$\\hat \\lambda(t_j) = \\frac{d_j}{r_j}$$\n\nwhere $d_j$ is the number of death at time $j$, and $r_j$ is the number of participants at risk at time $j$\n\nThe KM/product-limit estimator (for survival):\n$$\\hat S(t_j) = \\prod_{i=1}^{j}(1- \\hat \\lambda(t_i))$$\n\nan example can be found [here](https://thisislinyu.github.io/DLSPH/CHL5209/2024_03_08KM_curve.pdf)\n\nhere is my [cheatsheet](https://thisislinyu.github.io/DLSPH/CHL5209/survival_analysis_comps.pdf) for survival analysis basics.\n\n\n## Tutorial 7\n\nWe will cover parametric method, specifically, Cox regression, and time is treated as continuous.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(rms)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: Hmisc\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'Hmisc'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:dplyr':\n\n    src, summarize\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:base':\n\n    format.pval, units\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(survival)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'survival' was built under R version 4.3.2\n```\n\n\n:::\n\n```{.r .cell-code}\ndd <- datadist(mgus2)\noptions(datadist=\"dd\")\n\nfit.km <- npsurv(Surv(futime,death)~sex,data=mgus2)\n\n### Check exponential\nplot(fit.km,fun=\"cumhaz\")\n```\n\n::: {.cell-output-display}\n![](Tut7_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n\n```{.r .cell-code}\n## check proportionality (difference)\nplot(fit.km,fun=\"cloglog\")\n```\n\n::: {.cell-output-display}\n![](Tut7_files/figure-html/unnamed-chunk-2-2.png){width=672}\n:::\n\n```{.r .cell-code}\n## parametric model exp\nprint(fit1 <- psm(Surv(futime,death)~sex,\n                  data=mgus2,dist=\"exponential\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nParametric Survival Model: Exponential Distribution\n\npsm(formula = Surv(futime, death) ~ sex, data = mgus2, dist = \"exponential\")\n\n                 Model Likelihood     Discrimination    \n                       Ratio Test            Indexes    \nObs     1384    LR chi2      9.99     R2       0.007    \nEvents   963    d.f.            1    R2(1,1384)0.006    \nsigma 1.0000    Pr(> chi2) 0.0016     R2(1,963)0.009    \n                                      Dxy      0.062    \n\n            Coef    S.E.   Wald Z Pr(>|Z|)\n(Intercept)  5.0344 0.0486 103.54 <0.0001 \nsex=M       -0.2045 0.0649  -3.15 0.0016  \n```\n\n\n:::\n\n```{.r .cell-code}\n### HR for sex: M vs. F\nexp(-coef(fit1)[2])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   sex=M \n1.226934 \n```\n\n\n:::\n\n```{.r .cell-code}\n### Survival time ratio\nsummary(fit1,sex=\"F\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n             Effects              Response : Surv(futime, death) \n\n Factor               Low High Diff. Effect   S.E.    Lower 0.95 Upper 0.95\n sex - M:F            1   2    NA    -0.20452 0.06493 -0.33189   -0.077146 \n  Survival Time Ratio 1   2    NA     0.81504      NA  0.71757    0.925750 \n```\n\n\n:::\n\n```{.r .cell-code}\nsurvplot(fit1,sex)\n## KM non-parametric\nsurvplot(fit.km,add=TRUE,label.curves=FALSE,conf=\"none\",col=\"red\")\n```\n\n::: {.cell-output-display}\n![](Tut7_files/figure-html/unnamed-chunk-2-3.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n## fit weibull\nprint(fit2 <- psm(Surv(futime,death)~sex,data=mgus2,dist=\"weibull\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nParametric Survival Model: Weibull Distribution\n\npsm(formula = Surv(futime, death) ~ sex, data = mgus2, dist = \"weibull\")\n\n                 Model Likelihood     Discrimination    \n                       Ratio Test            Indexes    \nObs     1384    LR chi2      9.18     R2       0.007    \nEvents   963    d.f.            1    R2(1,1384)0.006    \nsigma 1.1016    Pr(> chi2) 0.0024     R2(1,963)0.008    \n                                      Dxy      0.062    \n\n            Coef    S.E.   Wald Z Pr(>|Z|)\n(Intercept)  5.0494 0.0538 93.87  <0.0001 \nsex=M       -0.2162 0.0716 -3.02  0.0025  \nLog(scale)   0.0967 0.0278  3.48  0.0005  \n```\n\n\n:::\n\n```{.r .cell-code}\n# phreg\n# survreg\n\n### HR for sex: M vs. F\n## weibull model: AFT parametrization\n## -gamma /scale\nexp(-coef(fit2)[2]/fit2$scale)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   sex=M \n1.216865 \n```\n\n\n:::\n\n```{.r .cell-code}\n### Survival time ratio\n\nsummary(fit2,sex=\"F\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n             Effects              Response : Surv(futime, death) \n\n Factor               Low High Diff. Effect   S.E.     Lower 0.95 Upper 0.95\n sex - M:F            1   2    NA    -0.21622 0.071609 -0.35669   -0.075742 \n  Survival Time Ratio 1   2    NA     0.80556       NA  0.69999    0.927060 \n```\n\n\n:::\n\n```{.r .cell-code}\nsurvplot(fit2,sex)\nsurvplot(fit.km,add=TRUE,label.curves=FALSE,conf=\"none\",col=\"red\")\n```\n\n::: {.cell-output-display}\n![](Tut7_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n\n```{.r .cell-code}\n## ---------------------------------------------------------------------------------------------\nsurvplot(fit.km,conf=\"none\")\nsurvplot(fit1,sex,add=TRUE,label.curves=FALSE,col=\"red\")\nsurvplot(fit2,sex,add=TRUE,label.curves=FALSE,col=\"blue\")\n```\n\n::: {.cell-output-display}\n![](Tut7_files/figure-html/unnamed-chunk-3-2.png){width=672}\n:::\n:::\n\n\n\n\n\n\nCox PH model\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprint(fit1.cox <- cph(Surv(futime,death)~sex,data=mgus2))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCox Proportional Hazards Model\n\ncph(formula = Surv(futime, death) ~ sex, data = mgus2)\n\n                       Model Tests     Discrimination    \n                                              Indexes    \nObs      1384    LR chi2      9.68     R2       0.007    \nEvents    963    d.f.            1    R2(1,1384)0.006    \nCenter 0.1098    Pr(> chi2) 0.0019     R2(1,963)0.009    \n                 Score chi2   9.65     Dxy      0.062    \n                 Pr(> chi2) 0.0019                       \n\n      Coef   S.E.   Wald Z Pr(>|Z|)\nsex=M 0.2017 0.0651 3.10   0.0019  \n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(fit1.cox,sex=\"F\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n             Effects              Response : Surv(futime, death) \n\n Factor        Low High Diff. Effect  S.E.     Lower 0.95 Upper 0.95\n sex - M:F     1   2    NA    0.20174 0.065062 0.074221   0.32926   \n  Hazard Ratio 1   2    NA    1.22350       NA 1.077000   1.38990   \n```\n\n\n:::\n\n```{.r .cell-code}\nprint(fit2.cox <- cph(Surv(futime,death)~sex+rcs(age,4),data=mgus2))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCox Proportional Hazards Model\n\ncph(formula = Surv(futime, death) ~ sex + rcs(age, 4), data = mgus2)\n\n                      Model Tests     Discrimination    \n                                             Indexes    \nObs     1384    LR chi2    396.10     R2       0.249    \nEvents   963    d.f.            4    R2(4,1384)0.247    \nCenter 3.248    Pr(> chi2) 0.0000     R2(4,963)0.334    \n                Score chi2 408.99     Dxy      0.334    \n                Pr(> chi2) 0.0000                       \n\n      Coef    S.E.   Wald Z Pr(>|Z|)\nsex=M  0.3605 0.0657  5.48  <0.0001 \nage    0.0380 0.0108  3.52  0.0004  \nage'   0.0473 0.0214  2.21  0.0272  \nage'' -0.2396 0.1233 -1.94  0.0520  \n```\n\n\n:::\n\n```{.r .cell-code}\n### LRT\n\nlrtest(fit1.cox,fit2.cox)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nModel 1: Surv(futime, death) ~ sex\nModel 2: Surv(futime, death) ~ sex + rcs(age, 4)\n\nL.R. Chisq       d.f.          P \n    386.42       3.00       0.00 \n```\n\n\n:::\n\n```{.r .cell-code}\n### Adjusted effect for sex\n\nsummary(fit2.cox,sex=\"F\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n             Effects              Response : Surv(futime, death) \n\n Factor        Low High Diff. Effect  S.E.     Lower 0.95 Upper 0.95\n age           63  79   16    1.13420 0.094988 0.94802    1.32040   \n  Hazard Ratio 63  79   16    3.10870       NA 2.58060    3.74480   \n sex - M:F      1   2   NA    0.36049 0.065742 0.23164    0.48935   \n  Hazard Ratio  1   2   NA    1.43400       NA 1.26070    1.63120   \n```\n\n\n:::\n\n```{.r .cell-code}\n### Plot of age effect\n# dev.off()\nplot(Predict(fit2.cox,age,sex))\n```\n\n::: {.cell-output-display}\n![](Tut7_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "Tut7_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}