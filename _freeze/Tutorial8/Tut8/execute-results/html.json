{
  "hash": "434f100ea0632389cb8f4dff78d8f1ba",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Survival Analysis 2\"\nauthor: \"Lin Yu\"\ndate: \"2025-03-17\"\nformat: \n  html: \n    toc: true\n    embed-resources: true\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(DT)\nlibrary(here)\n```\n:::\n\n\n\n\n\n\n\n\n## Recap of Tutorial 7\n\nWe went over how KM estimator (for survival probability) is constructed for discrete time. \n\nWe will discuss continuous time in this tutorial. \n\n## Tutorial 8\n\nToday we will cover diagnostics.\n\nPH assumption checked using [Schoenfeld residual](https://thisislinyu.github.io/DLSPH/STA2112/2024_04_02_STA2212_Cox_1972_final_project.pdf).\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(rms)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: Hmisc\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'Hmisc'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:dplyr':\n\n    src, summarize\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:base':\n\n    format.pval, units\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(survival)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'survival' was built under R version 4.3.2\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(lattice)\nstr(mgus2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n'data.frame':\t1384 obs. of  11 variables:\n $ id    : num  1 2 3 4 5 6 7 8 9 10 ...\n $ age   : num  88 78 94 68 90 90 89 87 86 79 ...\n  ..- attr(*, \"label\")= chr \"AGE AT mgus_sp\"\n $ sex   : Factor w/ 2 levels \"F\",\"M\": 1 1 2 2 1 2 1 1 1 1 ...\n  ..- attr(*, \"label\")= chr \"Sex\"\n  ..- attr(*, \"format\")= chr \"$desex\"\n $ dxyr  : num  1981 1968 1980 1977 1973 ...\n $ hgb   : num  13.1 11.5 10.5 15.2 10.7 12.9 10.5 12.3 14.5 9.4 ...\n $ creat : num  1.3 1.2 1.5 1.2 0.8 1 0.9 1.2 0.9 1.1 ...\n $ mspike: num  0.5 2 2.6 1.2 1 0.5 1.3 1.6 2.4 2.3 ...\n  ..- attr(*, \"label\")= chr \"SEP SPIKE AT mgus_sp\"\n $ ptime : num  30 25 46 92 8 4 151 2 57 136 ...\n $ pstat : num  0 0 0 0 0 0 0 0 0 0 ...\n $ futime: num  30 25 46 92 8 4 151 2 57 136 ...\n $ death : num  1 1 1 1 1 1 1 1 0 1 ...\n```\n\n\n:::\n\n```{.r .cell-code}\ndd <- datadist(mgus2)\noptions(datadist=\"dd\")\nstr(mgus2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n'data.frame':\t1384 obs. of  11 variables:\n $ id    : num  1 2 3 4 5 6 7 8 9 10 ...\n $ age   : num  88 78 94 68 90 90 89 87 86 79 ...\n  ..- attr(*, \"label\")= chr \"AGE AT mgus_sp\"\n $ sex   : Factor w/ 2 levels \"F\",\"M\": 1 1 2 2 1 2 1 1 1 1 ...\n  ..- attr(*, \"label\")= chr \"Sex\"\n  ..- attr(*, \"format\")= chr \"$desex\"\n $ dxyr  : num  1981 1968 1980 1977 1973 ...\n $ hgb   : num  13.1 11.5 10.5 15.2 10.7 12.9 10.5 12.3 14.5 9.4 ...\n $ creat : num  1.3 1.2 1.5 1.2 0.8 1 0.9 1.2 0.9 1.1 ...\n $ mspike: num  0.5 2 2.6 1.2 1 0.5 1.3 1.6 2.4 2.3 ...\n  ..- attr(*, \"label\")= chr \"SEP SPIKE AT mgus_sp\"\n $ ptime : num  30 25 46 92 8 4 151 2 57 136 ...\n $ pstat : num  0 0 0 0 0 0 0 0 0 0 ...\n $ futime: num  30 25 46 92 8 4 151 2 57 136 ...\n $ death : num  1 1 1 1 1 1 1 1 0 1 ...\n```\n\n\n:::\n\n```{.r .cell-code}\nfit1 <- cph(Surv(futime, death) ~ sex, data = mgus2, x = TRUE, y = TRUE)\nprint(fit1.zph <- cox.zph(fit1))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       chisq df    p\nsex     2.47  1 0.12\nGLOBAL  2.47  1 0.12\n```\n\n\n:::\n\n```{.r .cell-code}\nplot(fit1.zph)\n```\n\n::: {.cell-output-display}\n![](Tut8_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\ncheck function form for continuous covariates using martingale residual\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nres <- resid(fit1)\nres.lo <- loess(res~hgb,data=mgus2)\nres.ols <- ols(res~rcs(hgb,3),data=mgus2)\nres.ols <- ols(res~rcs(hgb,5),data=mgus2)\nplot(Predict(res.ols,hgb),addpanel=function(...){\n panel.points(mgus2$hgb,res)\n panel.lines(seq(5,20,length.out=25),\n predict(res.lo,seq(5,20,length.out=25)),col=\"red\")},\n ylim=1.15*range(res),\n ylab=\"Martingale Residual\",xlab=\"Hgb\")\n```\n\n::: {.cell-output-display}\n![](Tut8_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfit2 <- cph(Surv(futime, death) ~ sex * (rcs(age, 5) + rcs(hgb, 5) + rcs(creat,\n    5)), data = mgus2, x = TRUE, y = TRUE)\nanova(fit2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                Wald Statistics          Response: Surv(futime, death) \n\n Factor                                     Chi-Square d.f. P     \n sex  (Factor+Higher Order Factors)          40.49     13   0.0001\n  All Interactions                           14.79     12   0.2529\n age  (Factor+Higher Order Factors)         251.27      8   <.0001\n  All Interactions                            0.27      4   0.9919\n  Nonlinear (Factor+Higher Order Factors)     7.46      6   0.2805\n hgb  (Factor+Higher Order Factors)          56.74      8   <.0001\n  All Interactions                            0.36      4   0.9859\n  Nonlinear (Factor+Higher Order Factors)    12.45      6   0.0527\n creat  (Factor+Higher Order Factors)        44.76      8   <.0001\n  All Interactions                           13.57      4   0.0088\n  Nonlinear (Factor+Higher Order Factors)    28.66      6   0.0001\n sex * age  (Factor+Higher Order Factors)     0.27      4   0.9919\n  Nonlinear                                   0.23      3   0.9718\n  Nonlinear Interaction : f(A,B) vs. AB       0.23      3   0.9718\n sex * hgb  (Factor+Higher Order Factors)     0.36      4   0.9859\n  Nonlinear                                   0.08      3   0.9945\n  Nonlinear Interaction : f(A,B) vs. AB       0.08      3   0.9945\n sex * creat  (Factor+Higher Order Factors)  13.57      4   0.0088\n  Nonlinear                                  11.36      3   0.0100\n  Nonlinear Interaction : f(A,B) vs. AB      11.36      3   0.0100\n TOTAL NONLINEAR                             48.33     18   0.0001\n TOTAL INTERACTION                           14.79     12   0.2529\n TOTAL NONLINEAR + INTERACTION               56.21     21   <.0001\n TOTAL                                      468.25     25   <.0001\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1017)\nvalidate(fit2, B = 100)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in fitter(..., strata = strata, rownames = rownames, offset = offset, :\nLoglik converged before variable 20 ; coefficient may be infinite.\nWarning in fitter(..., strata = strata, rownames = rownames, offset = offset, :\nLoglik converged before variable 20 ; coefficient may be infinite.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      index.orig training   test optimism index.corrected   n\nDxy       0.4023   0.4091 0.3952   0.0138          0.3885 100\nR2        0.3091   0.3183 0.2874   0.0309          0.2782 100\nSlope     1.0000   1.0000 0.8971   0.1029          0.8971 100\nD         0.0407   0.0423 0.0373   0.0050          0.0357 100\nU        -0.0002  -0.0002 0.0033  -0.0035          0.0033 100\nQ         0.0408   0.0424 0.0340   0.0084          0.0324 100\ng         0.9390   0.9605 0.8614   0.0991          0.8399 100\n```\n\n\n:::\n:::\n",
    "supporting": [
      "Tut8_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}